<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.css">

<body>

<div class="container">
  <div id="auth"></div>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/react/0.13.1/react.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/react/0.13.1/JSXTransformer.js"></script>
<script type="text/jsx;harmony=true">
'use strict';

$.get('config.json', (config) => {
  var authMatch = window.location.href.match(/\?code=(.*)/);
  if(authMatch) {
    var code = authMatch[1];
    $.get(config.gatekeeper + '/authenticate/' + code, (resp) => {
      console.log(resp);
      if(resp.token) {
        localStorage.setItem('jekyllcms-github-token', resp.token);
        window.location.href = '/';
      }
    });
  }

  else {
    var authUrl = 'https://github.com/login/oauth/authorize' +
      '?client_id=' + encodeURIComponent(config.clientId) +
      '&scope=public_repo' +
      '&redirect_uri=' + encodeURIComponent(config.app + '/auth.html');

    var view = <a href={authUrl}>authorize</a>;
    React.render(view, document.querySelector('#auth'));
  }
});

</script>
